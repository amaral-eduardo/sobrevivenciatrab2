---
title: ''
output: pdf_document
---

```{r}
# Leitura dos dados -------------------------------------------------------
dados <- read.table("http://sobrevida.fiocruz.br/dados/ctinca.dat", header = TRUE)
head(dados)


# Pacotes -----------------------------------------------------------------
require(survival)
require(muhaz)
require(pander)
require(flexsurv)
require(hnp)
require(ggplot2)
require(survminer)
require(parmsurvfit)
require(pander)
require(hnp)
library(MASS)
library(dplyr)
library(gridExtra)

#Funções -----------------------------------------------------------------
# Função para Teste da Razão de Verossimilhanças (TRV)
TRV <- function(m0, m1) {
  # m0: Modelo nulo
  # m1: Modelo alternativo (saturado)
  TRV = 2 * (logLik(m1) - logLik(m0))
  gl = length(coef(m1)) - length(coef(m0))
  p = 1 - pchisq(TRV, gl)
  res = cbind(TRV, gl, p)
  return(res)
}



# Traducao dos dados ------------------------------------------------------
dados$sexo <- ifelse(dados$sexo == "Male","Mas","Fem")
dados$desnut <- ifelse(dados$desnut == "n", "Não", "Sim")
dados$comorbi <- ifelse(dados$comorbi == "n", "Não", "Sim")
dados$leucopenia <- ifelse(dados$leucopenia == "n", "Não", "Sim")

dados$sexo <- factor(dados$sexo, levels = c("Mas","Fem"))
dados$desnut <- factor(dados$desnut, levels = c("Sim","Não"))
dados$comorbi <- factor(dados$comorbi, levels = c("Sim","Não"))
dados$leucopenia <- factor(dados$leucopenia, levels = c("Sim","Não"))

dados$gptumor <- factor(dados$gptumor, levels = c("Loco", "Mtx", "Hemato"))



dados$gptumor <- factor(dados$gptumor, levels = c( "Mtx","Loco", "Hemato"))

summary(dados)

str(dados)

# Descritiva --------------------------------------------------------------
km1 <- survfit(Surv(tempo, status)~gptumor, dados)
plot(km1, xlab='Tempo', ylab='Prob de sobrevivencia', lwd=2, col=1:3)
legend('bottomleft', title='Tumores', c("Loco", "Mtx", "Hemato"), col=1:3, lwd=2, bty='n')

km2 <- survfit(Surv(tempo, status)~sexo, dados)
plot(km2, xlab='Tempo', ylab='Prob de sobrevivencia', lwd=2, col=1:2)
legend('bottomleft', title='Sexo', c("Mas","Fem"), col=1:2, lwd=2, bty='n')

km3 <- survfit(Surv(tempo, status)~desnut, dados)
plot(km3, xlab='Tempo', ylab='Prob de sobrevivencia', lwd=2, col=1:3)
legend('bottomleft', title='Desnutricao', c("Sim","Não"), col=1:3, lwd=2, bty='n')

km4 <- survfit(Surv(tempo, status)~comorbi, dados)
plot(km4, xlab='Tempo', ylab='Prob de sobrevivencia', lwd=2, col=1:3)
legend('bottomleft', title='Comorbidade', c("Sim","Não"), col=1:3, lwd=2, bty='n')

km5 <- survfit(Surv(tempo, status)~leucopenia, dados)
plot(km5, xlab='Tempo', ylab='Prob de sobrevivencia', lwd=2, col=1:3)
legend('bottomleft', title='Leucopenia', c("Sim","Não"), col=1:3, lwd=2, bty='n')

km1; km2; km3; km4; km5






s1 <- c() ; s2 <- c() 

for(i in 1:nrow(dados)) {
  s2[i] <- summary(fit4, type='survival', t=dados$tempo[i], newdata=dados[i,], tidy=T)$est
  if(i%%10==0) print(i)
}



a2 <- runif(length(s2), min=0, max=s2)
r2 <- ifelse(dados$status==1, qnorm(s2), qnorm(a2))


qqnorm(r2, main='Weibull')     ; abline(0,1)



hnp(r2, main='Weibull', half=F,print.on = T)    

########################

for(i in 1:nrow(dados)) {
  s2[i] <- summary(fit6, type='survival', t=dados$tempo[i], newdata=dados[i,], tidy=T)$est
  if(i%%10==0) print(i)
}



a2 <- runif(length(s2), min=0, max=s2)
r2 <- ifelse(dados$status==1, qnorm(s2), qnorm(a2))


qqnorm(r2, main='Weibull')     ; abline(0,1)



hnp(r2, main='Weibull', half=F,print.on = T)  
 



### teste variaveis
fit_nulo = flexsurvreg(Surv(tempo, status)~ 1, data=dados, dist='lnorm')

fit_SEM_sexo = flexsurvreg(Surv(tempo, status)~gptumor+desnut+comorbi+leucopenia, data=dados, dist='lnorm')
fit_SEM_gptumor = flexsurvreg(Surv(tempo, status)~gptumor+sexo+comorbi+leucopenia, data=dados, dist='lnorm')
fit_SEM_comorbi = flexsurvreg(Surv(tempo, status)~gptumor+sexo+desnut+leucopenia, data=dados, dist='lnorm')
fit_SEM_desnut = flexsurvreg(Surv(tempo, status)~gptumor+sexo+comorbi+leucopenia, data=dados, dist='lnorm')
fit_SEM_leucopenia = flexsurvreg(Surv(tempo, status)~gptumor+sexo+desnut+comorbi, data=dados, dist='lnorm')

TRV(fit_SEM_sexo, fit4) 
# tirar sexo
# TRV gl         p
# [1,] 1.964037  1 0.1610822

TRV(fit_SEM_gptumor, fit4) # gptumor IMPORTANTE

TRV(fit_SEM_comorbi, fit4) # comorbi IMPORTANTE

TRV(fit_SEM_desnut, fit4) # desnut IMPORTANTE

TRV(fit_SEM_leucopenia, fit4) # leucopenia IMPORTANTE


####fit_SEM_sexo é o melhor
fit_SEM_gptumor.2 = flexsurvreg(Surv(tempo, status)~desnut+comorbi+leucopenia, data=dados, dist='lnorm')
fit_SEM_comorbi.2 = flexsurvreg(Surv(tempo, status)~gptumor+desnut+leucopenia, data=dados, dist='lnorm')
fit_SEM_desnut.2 = flexsurvreg(Surv(tempo, status)~gptumor+comorbi+leucopenia, data=dados, dist='lnorm')
fit_SEM_leucopenia.2 = flexsurvreg(Surv(tempo, status)~gptumor+desnut+comorbi, data=dados, dist='lnorm')

        
TRV(fit_SEM_gptumor.2, fit_SEM_sexo)
TRV(fit_SEM_comorbi.2, fit_SEM_sexo)
TRV(fit_SEM_desnut.2, fit_SEM_sexo)
TRV(fit_SEM_leucopenia.2, fit_SEM_sexo)



##### fit_SEM_sexo é o melhor
fit_APENAS_gptumor = flexsurvreg(Surv(tempo, status)~gptumor, data=dados, dist='lnorm')
fit_APENAS_comorbi = flexsurvreg(Surv(tempo, status)~comorbi, data=dados, dist='lnorm')
fit_APENAS_desnut = flexsurvreg(Surv(tempo, status)~desnut, data=dados, dist='lnorm')
fit_APENAS_leucopenia = flexsurvreg(Surv(tempo, status)~leucopenia, data=dados, dist='lnorm')


TRV(fit_APENAS_gptumor, fit_SEM_sexo)
TRV(fit_APENAS_comorbi, fit_SEM_sexo)
TRV(fit_APENAS_desnut, fit_SEM_sexo)
TRV(fit_APENAS_leucopenia, fit_SEM_sexo)


##### fit_COM_idade é o melhor, sem sexo

fit_SEM_sexo = flexsurvreg(Surv(tempo, status)~gptumor+desnut+comorbi+leucopenia, data=dados, dist='lnorm')
fit_COM_idade = flexsurvreg(Surv(tempo, status)~gptumor+desnut+comorbi+leucopenia+idade, data=dados, dist='lnorm')

TRV(fit_SEM_sexo, fit_COM_idade)



AIC(fit4)
AIC(fit_COM_idade)

```


```{r}


```

```{r}
teste = fit.cure.model(Surv(tempo, status)~gptumor+desnut+comorbi+leucopenia+idade,
                       data=dados, 
                       dist='lognormal', 
                       formula.surv=list(~gptumor), 
                       type='mixture', 
                       link='logit')


AIC(teste)
summary(teste)

table(dados$gptumor)
```

```{r}

#“surv”, “curerate”, “probcure”, “survuncured”, “hazarduncured”, “cumhazuncured”, “densityuncured”, “failuncured”, “oddsuncured”, “loghazarduncured”, “hazard”, “density”, “fail”, “loghazard”, “odds”, “cumhaz”
predict(teste, newdata=data.frame(group=c('Mtx', 'Loco', 'Hemato')), type='curerate')

dados <- read.table("http://sobrevida.fiocruz.br/dados/ctinca.dat", header = TRUE)

teste = fit.cure.model(Surv(tempo, status)~gptumor+desnut+comorbi+leucopenia+idade,
                       data=dados, 
                       dist='lognormal', 
                       formula.surv=list(~gptumor), 
                       type='mixture', 
                       link='logit')

summary(teste)

s1 <- c() ; s2 <- c() ; s3 <- c() ; s5 <- c()

for(i in 1:nrow(dados)) {
  # Incluir todas as variáveis necessárias para a previsão
  new_data <- data.frame(
    gptumor = dados$gptumor[i],
    desnut = dados$desnut[i],
    comorbi = dados$comorbi[i],
    leucopenia = dados$leucopenia[i],
    idade = dados$idade[i]
  )
  
  s1[i] <- predict(teste, newdata=new_data, time=dados$tempo[i])[[1]]$Estimate
  #if(i %% 10 == 0) print(i)
}

a1 <- runif(length(s1), min=0, max=s1)
r1 <- ifelse(dados$status==1, qnorm(s1), qnorm(a1))

1-exp(-0.0269800)



require(hnp)
X11()
par(mfrow=c(2,2))
hnp(r1, main='1', print.on=T, half=F, pch=16)
hnp(r2, main='2', print.on=T, half=F, pch=16)    
hnp(r3, main='3', print.on=T, half=F, pch=16)
hnp(r5, main='5', print.on=T, half=F, pch=16)
```




# Regressão 


```{r}
# Regressão ---------------------------------------------------------------
fit1 <- flexsurvreg(Surv(tempo, status)~gptumor+sexo+desnut+comorbi+leucopenia+idade, data=dados, dist='exponential')

fit2 <- flexsurvreg(Surv(tempo, status)~gptumor+sexo+desnut+comorbi+leucopenia+idade, data=dados, dist='weibull')

fit3 <- flexsurvreg(Surv(tempo, status)~gptumor+sexo+desnut+comorbi+leucopenia+idade, data=dados, dist='gamma')

fit4 <- flexsurvreg(Surv(tempo, status)~gptumor+sexo+desnut+comorbi+leucopenia+idade, data=dados, dist='lnorm')

fit5 <- flexsurvreg(Surv(tempo, status)~gptumor+sexo+desnut+comorbi+leucopenia+idade, data=dados, dist='llogis')

fit6 <- flexsurvreg(Surv(tempo, status)~gptumor+sexo+desnut+comorbi+leucopenia+idade, data=dados, dist='gompertz')

fit7 <- flexsurvreg(Surv(tempo, status)~gptumor+sexo+desnut+comorbi+leucopenia+idade, data=dados, dist='gengamma')







aic_bic_valores <- data.frame(
  Modelo = c("Exponential", "Weibull", "Gamma", "Log-Normal", "Log-Logistic", "Gompertz", "Generalized Gamma"),
  AIC = c(AIC(fit1), AIC(fit2), AIC(fit3), AIC(fit4), AIC(fit5), AIC(fit6), AIC(fit7)),
  BIC = c(BIC(fit1), BIC(fit2), BIC(fit3), BIC(fit4), BIC(fit5), BIC(fit6), BIC(fit7))
)

#pander(aic_bic_valores)
aic_bic_valores_ordenado <- arrange(aic_bic_valores, AIC)
pander(aic_bic_valores_ordenado)
```



```{r}
fit_gengamma <- flexsurvreg(Surv(tempo, status)~gptumor+desnut+comorbi+leucopenia+idade, data=dados, dist='gengamma')

fit_gengamma
```



# Diagnóstico

```{r}
fit_gengamma <- flexsurvreg(Surv(tempo, status)~gptumor+desnut+comorbi+leucopenia+idade, data=dados, dist='gengamma')

fit_gompertz <- flexsurvreg(Surv(tempo, status)~gptumor+desnut+comorbi+leucopenia+idade, data=dados, dist='gompertz')
fit_lnorm <- flexsurvreg(Surv(tempo, status)~gptumor+desnut+comorbi+leucopenia+idade, data=dados, dist='lnorm')

AIC(fit_gengamma)
AIC(fit_gompertz)
AIC(fit_lnorm)

fit_gengamma
fit_gompertz
fit_lnorm
```



# Gráficos 

```{r}
for(i in 1:nrow(dados)) {
  s2[i] <- summary(fit_gengamma, type='survival', t=dados$tempo[i], newdata=dados[i,], tidy=T)$est
  
}
set.seed("110116")
a2 <- runif(length(s2), min=0, max=s2)
r2 <- ifelse(dados$status==1, qnorm(s2), qnorm(a2))
qqnorm(r2, main='gengamma')     ; abline(0,1)

hnp_fit_gengamma = hnp(r2, main='gengamma', half=F,print.on = T)  
```

```{r}
for(i in 1:nrow(dados)) {
  s2[i] <- summary(fit_gompertz, type='survival', t=dados$tempo[i], newdata=dados[i,], tidy=T)$est
  
}
set.seed("6545132")
a2 <- runif(length(s2), min=0, max=s2)
r2 <- ifelse(dados$status==1, qnorm(s2), qnorm(a2))
qqnorm(r2, main='fit_gompertz')     ; abline(0,1)

hnp_fit_gompertz = hnp(r2, main='fit_gompertz', half=F,print.on = T)  
```


```{r}
for(i in 1:nrow(dados)) {
  s2[i] <- summary(fit_lnorm, type='survival', t=dados$tempo[i], newdata=dados[i,], tidy=T)$est
  
}
set.seed("426545132")
a2 <- runif(length(s2), min=0, max=s2)
r2 <- ifelse(dados$status==1, qnorm(s2), qnorm(a2))
qqnorm(r2, main='fit_lnorm')     ; abline(0,1)

hnp_fit_lnorm = hnp(r2, main='fit_lnorm', half=F,print.on = T)  
```


Como os resíduos apresentaram um melhor ajuste à distribuição log-normal, essa será a escolha do modelo.


# Interpretação 


| Variável       | Estimativa (est) | Erro Padrão (se) | Exp da Estimativa (exp(est)) | Exp(L95%)  | Exp(U95%)  |
|----------------|-----------------:|-----------------:|-----------------------------:|-----------:|-----------:|
| idade          |           -0.027 |            0.006 |                        0.973 |      0.962 |      0.984 |
| gptumor Hemato |            0.092 |            0.293 |                        1.096 |      0.617 |      1.947 |
| gptumor Loco   |            1.502 |            0.234 |                        4.490 |      2.837 |      7.104 |
| desnut Não     |            1.124 |            0.339 |                        3.077 |      1.582 |      5.986 |
| comorbi Não    |            1.074 |            0.358 |                        2.926 |      1.450 |      5.907 |
| leucopenia Não |            1.719 |            0.355 |                        5.581 |      2.784 |     11.189 |


 - Idade: Para cada aumento de um ano na idade do paciente, observa-se uma redução de 2,7% no tempo mediano de sobrevida, já que a estimativa do efeito (exp(est)) é 0.973. O intervalo de confiança de 95% (IC 95%) para essa redução varia entre 3,8% (1 - 0.962) e 1,6% (1 - 0.984), indicando que estamos 95% confiantes de que a redução real no tempo mediano de sobrevida está entre esses valores para cada aumento de um ano na idade.

 - gptumor Hemato: Pacientes com tumor hematológico têm um tempo mediano de sobrevida 1,096 vezes o da categoria de referência, mas essa estimativa não é estatisticamente significativa, pois o intervalo de confiança de 95% varia de 0,617 a 1,947, incluindo o valor 1.

 - gptumor Loco: Pacientes com tumor sólido localizado têm um tempo mediano de sobrevida 4,49 vezes maior do que a categoria de referência. O intervalo de confiança de 95% indica que esse fator pode variar de 2,837 vezes a 7,104 vezes.

 - desnut Não: Pacientes que não apresentam perda de peso recente têm um tempo mediano de sobrevida 3,077 vezes maior do que aqueles com perda de peso recente. O intervalo de confiança de 95% sugere que esse fator varia de 1,582 vezes a 5,986 vezes.

 - comorbi Não: Pacientes sem comorbidades severas têm um tempo mediano de sobrevida 2,926 vezes maior do que aqueles com comorbidades severas. O intervalo de confiança de 95% mostra que esse aumento pode variar de 1,450 vezes a 5,907 vezes.

 - leucopenia Não: Pacientes que não apresentam leucopenia têm um tempo mediano de sobrevida 5,581 vezes maior do que aqueles com leucopenia, com um intervalo de confiança de 95% variando de 2,784 vezes a 11,189 vezes.


